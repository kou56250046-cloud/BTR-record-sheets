<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>BTRãƒ¡ã‚½ãƒƒãƒ‰ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-light: #f6f8fa;
      --text-light: #111;
      --bg-dark: #1e1e1e;
      --text-dark: #eee;
      --accent: #1976d2;
    }

    body {
      font-family: sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    h1, h2 { text-align: center; }

    .form-section {
      background: rgba(255,255,255,0.9);
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 10px;
    }
    body.dark .form-section {
      background: #2a2a2a;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 0.25rem;
    }
    button:hover { opacity: 0.85; }

    select {
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      width: 100%;
    }

    canvas {
      max-width: 100%;
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #e0e0e0;
    }
    body.dark th {
      background: #333;
    }

    .dark-toggle {
      float: right;
      background: none;
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    .dark-toggle:hover {
      background: var(--accent);
      color: #fff;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š BTRãƒ¡ã‚½ãƒƒãƒ‰ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</h1>
  <button class="dark-toggle" id="toggleTheme">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>

  <!-- ===== å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ===== -->
  <section class="form-section">
    <h2>è¨˜éŒ²å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
    <form id="recordForm">
      <h3>ğŸ‘ ç›®ã‚’é›ãˆã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h3>
      <div class="grid">
        <label>ãŸã¦ã‚µãƒƒã‚±ã‚¤ãƒ‰<input type="number" name="tate"></label>
        <label>ã‚ˆã“ã‚µãƒƒã‚±ã‚¤ãƒ‰<input type="number" name="yoko"></label>
        <label>ãƒ˜ãƒ«ãƒãƒ³ã‚·ãƒ¼ãƒˆ<input type="number" name="herman"></label>
        <label>åºƒè¦–é‡â‘ <input type="number" name="block1"></label>
        <label>åºƒè¦–é‡â‘¡<input type="number" name="block2"></label>
        <label>æ¼¢æ•°å­—ä¸€è¡Œ<input type="number" name="kanji"></label>
        <label>ã‚ˆã“ä¸€è¡Œãƒ¦ãƒ‹ãƒƒãƒˆ<input type="number" name="yokounit"></label>
      </div>

      <h3>ğŸ§  è„³ã‚’ç£¨ããƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h3>
      <div class="grid">
        <label>æ•°å­—ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚§ãƒƒã‚¯<input type="number" name="numcheck"></label>
        <label>ãƒ­ã‚¸ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ<input type="number" name="logical"></label>
        <label>ã‚¤ãƒ¡ãƒ¼ã‚¸è¨˜æ†¶<input type="number" name="imgmemory"></label>
        <label>ã‚¤ãƒ¡ãƒ¼ã‚¸èª­ã¿<input type="number" name="imgread"></label>
        <label>ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯<input type="number" name="speedcheck"></label>
        <label>ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰<input type="number" name="speedboard"></label>
      </div>
      <button type="submit">è¨˜éŒ²ã™ã‚‹</button>
    </form>
  </section>

  <!-- ===== è¡¨ç¤ºè¨­å®š ===== -->
  <section>
    <h2>ğŸ“ˆ è¡¨ç¤ºè¨­å®š</h2>
    <select id="itemSelect"></select>
    <button class="filter-btn" data-range="daily">æ—¥åˆ¥</button>
    <button class="filter-btn" data-range="weekly">é€±åˆ¥</button>
    <button class="filter-btn" data-range="monthly">æœˆåˆ¥</button>
  </section>

  <!-- ===== ã‚°ãƒ©ãƒ• ===== -->
  <section>
    <canvas id="mainChart"></canvas>
  </section>

  <!-- ===== ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« ===== -->
  <section>
    <h2>ğŸ“‹ è¨˜éŒ²ãƒ­ã‚°</h2>
    <table id="logTable"></table>
  </section>

  <!-- ===== CSVãƒ»ãƒªã‚»ãƒƒãƒˆ ===== -->
  <section>
    <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
    <button id="downloadCsv">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <input type="file" id="uploadCsv" accept=".csv">
    <button id="resetData" style="background:#d32f2f;">å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </section>

  <script>
    // ==== ãƒ©ãƒ™ãƒ«è¨­å®š ====
    const labelsMap = {
      tate: "ãŸã¦ã‚µãƒƒã‚±ã‚¤ãƒ‰",
      yoko: "ã‚ˆã“ã‚µãƒƒã‚±ã‚¤ãƒ‰",
      herman: "ãƒ˜ãƒ«ãƒãƒ³ã‚·ãƒ¼ãƒˆ",
      block1: "åºƒè¦–é‡â‘ ",
      block2: "åºƒè¦–é‡â‘¡",
      kanji: "æ¼¢æ•°å­—ä¸€è¡Œ",
      yokounit: "ã‚ˆã“ä¸€è¡Œãƒ¦ãƒ‹ãƒƒãƒˆ",
      numcheck: "æ•°å­—ãƒ©ãƒ³ãƒ€ãƒ ãƒã‚§ãƒƒã‚¯",
      logical: "ãƒ­ã‚¸ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ",
      imgmemory: "ã‚¤ãƒ¡ãƒ¼ã‚¸è¨˜æ†¶",
      imgread: "ã‚¤ãƒ¡ãƒ¼ã‚¸èª­ã¿",
      speedcheck: "ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯",
      speedboard: "ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰"
    };

    let allData = [];
    let currentRange = "daily";
    let chartInstance = null;

    // ===== åˆæœŸåŒ– =====
    document.addEventListener("DOMContentLoaded", () => {
      createItemSelect();
      loadLocal();
      renderChart();
      renderTable();
    });

    // ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    document.getElementById("toggleTheme").addEventListener("click", () => {
      document.body.classList.toggle("dark");
    });

    // ğŸ“ è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById("recordForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const record = { date: new Date().toISOString().split("T")[0] };
      for (const [key, value] of formData.entries()) {
        if (value !== "") { // âœ… ç©ºæ¬„ã¯ç™»éŒ²ã—ãªã„
          record[key] = Number(value);
        }
      }
      allData.push(record);
      saveLocal();
      renderChart();
      renderTable();
      e.target.reset();
    });

    // ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
    document.getElementById("downloadCsv").addEventListener("click", () => {
      const csv = convertToCsv(allData);
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "btr_data.csv";
      a.click();
    });

    // ===== CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
    document.getElementById("uploadCsv").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        allData = parseCsv(evt.target.result);
        saveLocal();
        renderChart();
        renderTable();
      };
      reader.readAsText(file);
    });

    // ===== å±¥æ­´ãƒªã‚»ãƒƒãƒˆ =====
    document.getElementById("resetData").addEventListener("click", () => {
      if (!confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      allData = [];
      localStorage.removeItem("btrData");
      renderChart();
      renderTable();
    });

    // ===== è¡¨ç¤ºæœŸé–“åˆ‡æ›¿ =====
    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        currentRange = btn.dataset.range;
        renderChart();
      });
    });

    // ===== ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ =====
    function createItemSelect() {
      const sel = document.getElementById("itemSelect");
      Object.entries(labelsMap).forEach(([key, label]) => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = label;
        sel.appendChild(option);
      });
      sel.addEventListener("change", renderChart);
    }

    // ===== é›†è¨ˆ =====
    function aggregateData(range) {
      const grouped = {};
      allData.forEach(row => {
        const date = new Date(row.date);
        let key;
        if (range === "daily") key = row.date;
        else if (range === "weekly") {
          const start = new Date(date.setDate(date.getDate() - date.getDay()));
          key = start.toISOString().split("T")[0];
        } else {
          key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}`;
        }
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
      });

      const result = [];
      for (const [key, rows] of Object.entries(grouped)) {
        const agg = { date: key };
        for (const col of Object.keys(labelsMap)) {
          const valid = rows.map(r => r[col]).filter(v => typeof v === "number" && !isNaN(v));
          agg[col] = valid.length ? valid.reduce((s, v) => s + v, 0) / valid.length : 0;
        }
        result.push(agg);
      }
      result.sort((a,b)=> new Date(a.date)-new Date(b.date));
      return result;
    }

    // ===== ã‚°ãƒ©ãƒ•æç”» =====
    function renderChart() {
      const key = document.getElementById("itemSelect").value || "tate";
      const data = aggregateData(currentRange);
      const ctx = document.getElementById("mainChart").getContext("2d");

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map(d => d.date),
          datasets: [
            {
              label: labelsMap[key],
              data: data.map(d => d[key]),
              borderColor: "#1976d2",
              backgroundColor: "rgba(25,118,210,0.5)"
            },
            {
              label: labelsMap[key] + "ï¼ˆæŠ˜ã‚Œç·šï¼‰",
              data: data.map(d => d[key]),
              borderColor: "#d32f2f",
              type: "line",
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    }

    // ===== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» =====
    function renderTable() {
      const table = document.getElementById("logTable");
      const headers = ["æ—¥ä»˜", ...Object.values(labelsMap)];
      let html = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
      allData.forEach(row => {
        html += "<tr><td>" + row.date + "</td>";
        for (const col of Object.keys(labelsMap)) {
          html += `<td>${row[col] ?? ""}</td>`;
        }
        html += "</tr>";
      });
      table.innerHTML = html;
    }

    // ===== CSVé–¢é€£ =====
    function convertToCsv(data) {
      const headers = ["date", ...Object.keys(labelsMap)];
      const rows = data.map(d => headers.map(h => d[h] ?? "").join(","));
      return [headers.join(","), ...rows].join("\n");
    }

    function parseCsv(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h] = h === "date" ? cols[i] : Number(cols[i]));
        return obj;
      });
    }

    // ===== LocalStorage =====
    function saveLocal() {
      localStorage.setItem("btrData", convertToCsv(allData));
    }
    function loadLocal() {
      const csv = localStorage.getItem("btrData");
      if (csv) allData = parseCsv(csv);
    }
  </script>
</body>
</html>
